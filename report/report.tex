\documentclass[11pt, a4paper]{article}

% Packages
\usepackage[french]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}

\usepackage[left=2cm, right=2cm, top=2cm, bottom=2cm]{geometry}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{hyperref}

\usepackage{float}

\usepackage{graphicx}
\graphicspath{{./img/}}
\usepackage{tikz}

% Reset paragraph indentation -------------------------------------------------
\setlength{\parindent}{0cm}

% Allow a paragraph to have a linebreak ---------------------------------------
\newcommand{\paragraphnl}[1]{\paragraph{#1}\mbox{}\\}

% Page header and footer ------------------------------------------------------
\pagestyle{fancy}
\setlength{\headheight}{33pt}
\renewcommand{\headrulewidth}{0.5pt}
\lhead{\includegraphics[height=1cm]{hepia.jpg}}
\chead{SmartFolder}
\rhead{Claudio Sousa - David Gonzalez}
\renewcommand{\footrulewidth}{0.5pt}
\lfoot{22 décembre 2016}
\cfoot{}
\rfoot{Page \thepage /\pageref{LastPage}}

% Table of contents depth -----------------------------------------------------
\setcounter{tocdepth}{3}

% Document --------------------------------------------------------------------
\begin{document}

\title
{
    \Huge{Programmation système} \\
    \Huge{SmartFolder}
}
\author
{
    \LARGE{David Gonzalez - Claudio Sousa}
}
\date{22 décembre 2016}
\maketitle

\begin{center}
    %\includegraphics[scale=0.27]{logo.png}
\end{center}

\thispagestyle{empty}

\newpage

% -----------------------------------------------------------------------------
\section{Introduction}

Ce TP de deuxième année en programmation système consiste à implémenter un programme similaire au SmartFolder sur MacOSX. \\

Le SmartFolder sur MacOSX recherche sur le disque des fichiers correspondant à un/des critères et,
pour chacun des fichiers trouvés, le programme crée un lien symbolique dans un dossier specifié.

\subsection{Spécification fonctionnelle}
Ce programme possède deux modes de fonctionnement.

\subsubsection{Mode recherche}
C'est le mode par défaut et simule le SmartFolder sur MacOSX. \\

Dans ce mode, le programme tourne en arrière-plan et maintient dans le dossier de destination une liste de liens vers les fichier trouvés correpondant aux critères de recherche choisis.
Cette liste est dynamique et mise à jour si des nouveaux fichiers répondent aux critères de recherche ou, si au contraire, des fichiers ne répondent plus à ces critères. \\

La recherche de fichiers est recursive et suit les liens symboliques.

Par ailleurs, les fichiers en double ne doivent pas apparaître et les fichiers portant le même nom doivent être renommés intelligemment. \\

Ce mode prend 3 paramètres:
\begin{itemize}
    \item \textit{<dir\_name>}: chemin (de destination) où stocker les liens;
    \item \textit{<search\_path>}: chemin de recherche;
    \item \textit{<expression>}: critères de sélection. \\
\end{itemize}

\textit{<dir\_name>} et \textit{<search\_path>} sont de simples chemins vers des dossiers.\\
\textit{<expression>} correspond à une liste de critères dont l'interface est un sous-ensemble de celle de \textit{find}.

\paragraphnl{Expression}
Comme dit précédemment, l'interface est semblable à celle de \textit{find}\footnote{\url{https://linux.die.net/man/1/find}}.
Voici la liste des options pris en charge:\\


Criteres:
\begin{itemize}
	\renewcommand\labelitemi{}
	\renewcommand\labelitemii{}
	\renewcommand\labelitemiii{}
    \item \textit{-name}: \underline{fname}
	\begin{itemize}
		\item Le nom de fichier est exactement \underline{fname}
		\item Example, les fichiers només  "todo.txt": \textit{-name todo.txt}
	\end{itemize}
    \item \textit{-name}: -\underline{fname} 
	\begin{itemize}
    \item     Le nom de fichier contient \underline{fname}.
    \item     Example, les fichiers contenant ".txt":
    \textit{-name -.txt}
	\end{itemize}
	\item \textit{-group}: \underline{gname}
	\begin{itemize}
    \item 	   	Le fichier appartient au group \underline{gname}
    \item 	   	Example, les fichiers appartenant au group \textit{root}: \textit{-group root}
\end{itemize}
\item \textit{-user}: \underline{uname}
	\begin{itemize}
    \item 		Le fichier est possédé par utilisateur \underline{uname} 
    \item 	   	Example, les fichiers possédés par l'utilisateur \textit{claudio}: \textit{-user claudio}
	\end{itemize}
	\item \textit{-perm}: \underline{perm}
	\begin{itemize}
    \item 		Les permissions sont exactement \underline{perm}
    \item 		Example, les fichiers ayant exactement les permissions 644: \textit{-perm 644}
	\end{itemize}
	\item \textit{-perm}: -\underline{perm}
	\begin{itemize}
    \item 		Le fichier a au moins les permissions \underline{perm}
    \item 		Example, les fichiers dont l'utilisateur peut lire et executer: \textit{-perm -500}
	\end{itemize}
	\item \textit{-size}: \underline{[+-]size[GMkc]}
	\begin{itemize}
    \item 		Le fichier a la taille \underline{size}.
    \item 		Le suffix indique l'unité utilisée:
		\begin{itemize}
			\item \textit{'c'}: bytes
			\item \textit{'k'}: Kilobytes
			\item \textit{'M'}: Megabytes
			\item \textit{'G'}: Gigabytes
		\end{itemize}
		Le préfixe indique la comparaison utilisée:
		\begin{itemize}
			\item \textit{'+'}: supérieur à
			\item \textit{'-'}: inférieur à
			\item \textit{''}: exactement
		\end{itemize}
		Examples:
		\begin{itemize}
			\item \textit{-size 200c}: fichiers de taille 200 bytes		
			\item \textit{-size -30k}: fichiers de taille inférieure à 30KB
			\item \textit{-size +2M}: fichiers de taille supérieure à 2MB
		\end{itemize}
	\end{itemize}
	\item \textit{-atime}: \underline{[+-]time[md]}
	\begin{itemize}
\item	Le fichier fut accédé depuis \underline{time}. La référence de temps est le moment présent.
\item	Le suffix indique l'unité utilisée:
	\begin{itemize}
		\item \textit{'m'}: minutes
		\item \textit{'d'}: jours 
	\end{itemize}
	Le préfixe \textit{[+-]} indique la comparaison utilisée, comme pour le critère \underline{-size} ci-dessus.\\
	Examples:
	\begin{itemize}
		\item \textit{-atime +5m}: fichiers accédés depuis plus de 5 minutes
		\item \textit{-atime -1d}: fichiers accédés dans les dernières 24 heures
	\end{itemize}
	\end{itemize}
	\item \textit{-ctime}: \underline{[+-]time[md]}
\begin{itemize}
	\item 	Le status du fichier fut changé depuis \underline{time}. 
	\item Pour plus détails, voir l'explication pour le critère \underline{-atime}
	\end{itemize}
	\item \textit{-mtime}: \underline{[+-]time[md]}
\begin{itemize}
	\item 	Le fichier fut changé depuis \underline{time}.\\
	 Pour plus détails, voir l'explication pour le critère \underline{-atime}	\\	
	\end{itemize}
\end{itemize}


Les differents critères enumérés ci-dessus peuvent être combinés avec les opérateurs listés ci-dessous, énumérés dans l'odre de précédence décroissante:\\

Opérateurs:
\begin{itemize}
	\renewcommand\labelitemi{}
	\item \textit{( critère )}: force la précédence de l'expression entre paranthèses
	\item \textit{-not}: applique le \textit{NOT} logique  au critère de droite
	\item \textit{-and}: applique le \textit{AND} logique entre le critères à gauche et à droite de l'opérateur
	\item \textit{-or}: applique le \textit{OR} logique  entre les critères à gauche et à droite de l'opérateur
\end{itemize}


\subsubsection{Mode stop}
Le mode \textit{stop} permet d'arrêter une recherche en cours. \\

Ce mode prend en paramètre:
\begin{itemize}
	\renewcommand\labelitemi{}
    \item \textit{-d} \textit{<dir\_name>}: termine le SmatFolder pour le chemin de destination specifié.
\end{itemize}

\newpage

% -----------------------------------------------------------------------------
\section{Development}
\subsection{Architecture}

\begin{figure}[H]
    \begin{center}
        \includegraphics[width=\textwidth]{modules.png}
    \end{center}
    \caption{Architecture du SmartFolder}
    \label{Architecture du SmartFolder}
\end{figure}

\newpage

\subsubsection{Main}

Le programme principal a pour rôle de vérifier les arguments et de sélectionner le bon mode de fonctionnement.

Dans le mode \textit{recherche}, il a pour tâche de:
\begin{itemize}
    \item met le processus en arrière-plan;
    \item demande au module \textit{Parser} de traiter l'expression;
    \item initialise le module \textit{IPC};
    \item initialise et lance le module \textit{SmartFolder}.\\
\end{itemize}

Dans le mode \textit{stop}, son seul rôle est de signaler l'arrêt à l'autre instance (voir \nameref{sec:ipc}).

\subsubsection{SmartFolder}
\textit{SmartFolder} est le module principal qui va orchestrer la recherche et la mise à jour du dossier de destination. \\

Lorsque lancé, il va continuellement utiliser le module \textit{Finder} pour rechercher les fichiers correspondant au critère,
puis donner la liste des fichiers retournée au module \textit{Linker} pour qu'il mette à jour le répertoire de destination.

A noter qu'entre chaque recherche, il y a une pause de quelques secondes. \\

A l'arrêt, il est chargé de détruire le répertoire de destination et de libérer ses ressources.

\subsubsection{Parser}
\textit{Parser} est le module qui transforme
l'expression spécifiée dans la ligne de commande (critères de recherche) en une structure interne utilisable par le module \textit{Validator}. \\

La complexité des différents opérateurs logiques possibles (priorité, parenthèses, opérateur unaire) doit être connue uniquement de ce module. La structure retournée doit pouvoir être traitée simplement par le module \textit{Validator}. \\

Suggestion d'implémentation: utiliser l'algorithme de \textit{shunting-yard}\footnote{\url{https://en.wikipedia.org/wiki/Shunting-yard\_algorithm} (par Edsger Dijkstra)} pour le traitement de l'expression.

\subsubsection{Validator}
Ce module vérifie si un fichier est valide selon l'expression créée par le module \textit{Parser}.

\subsubsection{Finder}
Ce module est responsable de produire la liste de tous les fichiers du dossier de recherche respectant les criteres de recherche.

La vérification des fichiers contre les critères est déleguée au module \textit{Validator}.\\

Lors du processus de recherche effectué au sein de ce module, un parcours d'arborescence est effectué recursivement et les liens symboliques sont suivis.

Des boucles deviennent alors possibles. Ce module doit donc gérer ce cas spécifique et prévenir les boucles infinies ainsi que le traitement des fichiers et dossiers dupliqués. \\

Possibilité d'implémentation: utilisation d'une table de hashage contenant les numéros d'inode des fichiers et répertoires déjà parcourus.

\subsubsection{Linker}
Le module \textit{Linker} a pour rôle de mettre à jour le dossier de destination
à l'aide d'une liste de fichiers passée en paramètre. \\

Pour chaque fichier, il crée un lien si celui-ci n'existe pas. Les liens qui ne sont plus valides sont effacés.

\subsubsection{IPC}
\label{sec:ipc}
Ce module a pour but de répondre au problème du mode \textit{stop}.
En effet, lorsqu'une instance de \textit{SmartFolder} souhaite arrêter une autre instance en cours d'exécution,
il faut d'une manière ou d'une autre permettre une communication simple entre les deux processus afin
qu'une instance puisse signaler un arrêt à une autre instance. \\

Le moyen de communication choisi est les signaux POSIX, le signal \textit{SIGTERM} pour être plus précis.
Une instance qui veut donc signaler l'arrêt doit envoyer le signal cité au processus concerné. \\

Afin de pouvoir lancer un signal, il faut que le PID du processus cible soit connu.
Pour cela, le PID d'une instance en mode \textit{recherche} est stocké dans un fichier
dans le répertoire utilisateur.

Comme une instance de \textit{SmartFolder} est unique par dossier de destination,
ce fichier se nommera d'après le chemin de ce répertoire.

\subsubsection{IO}
Le but de ce module est d'offrir une interface simple aux appels systèmes et de centraliser la gestion des erreurs.

\subsubsection{Logger}
Ce module centralise l'affichage des logs de débogage.

\end{document}
