\documentclass[11pt, a4paper]{article}

% Packages
\usepackage[french]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}

\usepackage[left=2cm, right=2cm, top=2cm, bottom=2cm]{geometry}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{hyperref}

\usepackage{float}

\usepackage{graphicx}
\graphicspath{{./img/}}
\usepackage{tikz}

% Reset paragraph indentation -------------------------------------------------
\setlength{\parindent}{0cm}

% Allow a paragraph to have a linebreak ---------------------------------------
\newcommand{\paragraphnl}[1]{\paragraph{#1}\mbox{}\\}

% Page header and footer ------------------------------------------------------
\pagestyle{fancy}
\setlength{\headheight}{33pt}
\renewcommand{\headrulewidth}{0.5pt}
\lhead{\includegraphics[height=1cm]{hepia.jpg}}
\chead{SmartFolder}
\rhead{Claudio Sousa - David Gonzalez}
\renewcommand{\footrulewidth}{0.5pt}
\lfoot{23 décembre 2016}
\cfoot{}
\rfoot{Page \thepage /\pageref{LastPage}}

% Table of contents depth -----------------------------------------------------
\setcounter{tocdepth}{3}

% Document --------------------------------------------------------------------
\begin{document}

\title
{
    \Huge{Programmation système} \\
    \Huge{SmartFolder}
}
\author
{
    \LARGE{David Gonzalez - Claudio Sousa}
}
\date{23 décembre 2016}
\maketitle

\begin{center}
    %\includegraphics[scale=0.27]{logo.png}
\end{center}

\thispagestyle{empty}

\newpage

% -----------------------------------------------------------------------------
\section{Introduction}

Ce TP de deuxième année en programmation système consiste à implémenter un programme similaire au SmartFolder sur MacOSX. \\

Le SmartFolder sur MacOSX recherche sur le disque des fichiers correspondant à un/des critères et,
pour chacun des fichiers trouvés, le programme crée un lien symbolique dans un dossier specifié.

\subsection{Spécification fonctionnelle}
Ce programme possède deux modes de fonctionnement.

\subsubsection{Mode recherche}
Le premier est le mode \textit{recherche}.
C'est le mode par défaut et simule le SmartFolder sur MacOSX.\\\\
Dans ce mode, le programme tourne en background (daemon) et maintient dans le dossier de destination une liste de liens vers les fichier trouvés correpondant au criteres de recherche choisis. Cette liste est dynamique et mise à jour si des nouveaux fichiers répondent aux criteres des recherches ou, si au contraire, des fichiers ne répondent plus à ces criteres.\\

La recherche de fichiers dans le chemin de recherche est recursive et suit les chemins symboliques. 

Ce mode prend 3 paramètres:
\begin{itemize}
    \item \textit{<dir\_name>}: chemin où stocker les liens;
    \item \textit{<search\_path>}: chemin de recherche;
    \item \textit{<expression>}: critères de sélection. \\
\end{itemize}

\textit{<dir\_name>} et \textit{<search\_path>} sont de simples chemins vers des dossiers.\\
\textit{<expression>} correspond à une liste de critères dont l'interface est un sous-ensemble à celle de \textit{find}.

\paragraphnl{Expression}
Comme dit précédemment, l'interface est semblable à celle de \textit{\href{https://linux.die.net/man/1/find}{find}}.
Voici la liste des options pris en charge:

\begin{itemize}
    \item \textit{...}: ...;
\end{itemize}

\paragraphnl{Output/comportement}

Si des liens symboliques existent, ils doivent être suivis. Des fichiers a doublent ne doivent pas apparaitre dupliqués dans le dossier de destination.

\subsubsection{Mode stop}
Le deuxième est le mode \textit{stop}.
Il permet d'arrêter une recherche en cours. \\

Ce mode prend 1 paramètre:
\begin{itemize}
    \item \textit{-d} \textit{<dir\_name>}: termine le SmatFolder pour le chemin specifié.
\end{itemize}

\newpage

% -----------------------------------------------------------------------------
\section{Development}
\subsection{Architecture}

\begin{figure}[H]
    \begin{center}
        \includegraphics[width=\textwidth]{modules.png}
    \end{center}
    \caption{Architecture du SmartFolder}
    \label{Architecture du SmartFolder}
\end{figure}

\subsubsection{Main}

Le programme principal a pour rôle de vérifier les arguments et de sélectionner le bon mode de fonctionnement.

Dans le mode \textit{recherche}, il a pour tâche de:
\begin{itemize}
    \item met le processus en arrière-plan;
    \item demande au module \textit{Parser} de traiter l'expression;
    \item initialise le module \textit{IPC};
    \item initialise et lance le module \textit{SmartFolder}.\\
\end{itemize}

Dans le mode \textit{stop}, son seul rôle est de signaler l'arrêt à l'autre instance (voir \nameref{sec:ipc}).

\subsubsection{SmartFolder}
\textit{SmartFolder} est le module principal qui va orchestrer la recherche et la mise à jour du dossier de destination. \\

Lorsque lancé, il va continuellement utiliser le module \textit{Finder} pour rechercher les fichiers correspondant au critère,
puis donner la liste des fichiers retournée au module \textit{Linker} pour qu'il mette à jour le répertoire de destination.

A noter qu'entre chaque recherche, il y a une pause de quelques secondes. \\

A l'arrêt, il est chargé de détruire le répertoire de destination et de libérer ses ressources.

\subsubsection{Parser}
\textit{Parser} est le module qui transforme
l'expression spécifiée dans la ligne de commande (critères de recherche) en une structure interne utilisable par le module \textit{Validator}.\\

La compléxitée des diferents operateurs logiques possibles (priorité, parenthèses, op uniaire) doit être connue uniquement de ce module. La structure retournée doit pouvoir être traitée simplement par le module \textit{Validator}.\\ 

Suggestion d'implémentation: s'inspirer le l'algorithme de shunting-yard (ADD FOOTNODE WITH URL) pour le traitement de l'expression (url: https://en.wikipedia.org/wiki/Shunting-yard\_algorithm) (par  Edsger Dijkstra)

\subsubsection{Validator}
Ce module vérifie si un fichier est valide selon l'expression créée par le module \textit{Parser}.

\subsubsection{Finder}
Ce module est responsable de produire la liste de tous les fichiers du dossier de recherche respectant les criteres de recherche.

La verification des fichiers contre l'expression est deleguée au module \textit{Validator}.\\

Lors du processus de recherche effectué au sein de ce module, un parcours d'arborescence est effectué recursivement et les liens symboliques sont suivis. Des boucles deviennent alors possibles. Ce module doit gerer ce cas spécifique et prevenir des boucles infinites ainsi que le traitement dupliqué de fichiers et dossiers.
Possibilité d'implémentation: utilisation d'une hashtable contennant les numeros de serie des fichiers et folders deja parcourus (champ \textit{st\_ino} de \textit{struct stat}.)

\subsubsection{Linker}
Le module \textit{Linker} a pour rôle de mettre à jour le dossier de destination
à l'aide d'une liste de fichiers passée en paramètre. \\

Pour chaque fichier, il crée un lien si celui-ci n'existe pas. Les liens qui ne sont plus valides sont effacés. 

\subsubsection{IPC}
\label{sec:ipc}
Ce module a pour but de répondre au problème du mode \textit{stop}.
En effet, lorsqu'une instance de \textit{SmartFolder} souhaite arrêter une autre instance en cours d'exécution,
il faut d'une manière ou d'une autre permettre une communication simple entre les deux processus afin
qu'une instance puisse signaler un arrêt à une autre instance. \\

Le moyen de communication choisi a été les signaux POSIX, le signal \textit{SIGTERM} pour être plus précis.
Une instance qui veut donc signaler l'arrêt doit envoyer le signal cité au processus concerné. \\

Afin de pouvoir lancer un signal, il faut que le PID du processus cible soit connu.
Pour cela, le PID d'une instance en mode \textit{recherche} est stocké dans un fichier
dans le répertoire utilisateur.

Comme une instance de \textit{SmartFolder} est unique par dossier de destination,
ce fichier se nommera d'après le chemin de ce répertoire.

\subsubsection{IO}
Le but de ce module est d'offrir une interface simple aux appels systèmes et de centraliser la gestion des erreurs.

\subsubsection{Logger}
Module qui centralise l'affichage des logs de debogage. 

\end{document}
