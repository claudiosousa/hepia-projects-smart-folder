<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Search folder: ipc.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icon.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Search folder
   </div>
   <div id="projectbrief">System programming semester project</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">ipc.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Manage communication between different instance of smartfolder.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;unistd.h&gt;</code><br />
<code>#include &lt;signal.h&gt;</code><br />
<code>#include &lt;inttypes.h&gt;</code><br />
<code>#include &quot;<a class="el" href="ipc_8h_source.html">ipc.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="io_8h_source.html">io.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="logger_8h_source.html">logger.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for ipc.c:</div>
<div class="dyncontent">
<div class="center"><img src="ipc_8c__incl.png" border="0" usemap="#ipc_8c" alt=""/></div>
<map name="ipc_8c" id="ipc_8c">
<area shape="rect" id="node7" href="ipc_8h.html" title="Manage communication between different instance of smartfolder. " alt="" coords="468,80,519,107"/>
<area shape="rect" id="node8" href="io_8h.html" title="Helpers function around system calls for IO purpose. " alt="" coords="543,80,585,107"/>
<area shape="rect" id="node12" href="logger_8h.html" title="Simple logger functions that allow logging of various informations and errors. " alt="" coords="610,80,678,107"/>
</map>
</div>
</div>
<p><a href="ipc_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a62451a7cf42dd8bb5d114bdd83b60520"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a62451a7cf42dd8bb5d114bdd83b60520"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>IPC_MAX_PID_SIZE</b>&#160;&#160;&#160;10</td></tr>
<tr class="separator:a62451a7cf42dd8bb5d114bdd83b60520"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a000cc2e9e8132b15572f3e3ac63ebfde"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a000cc2e9e8132b15572f3e3ac63ebfde"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>IPC_HOME_PATH</b>&#160;&#160;&#160;&quot;/.searchfolder/&quot;</td></tr>
<tr class="separator:a000cc2e9e8132b15572f3e3ac63ebfde"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1d9abc515eaca8f30f4215eadb7417a2"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a1d9abc515eaca8f30f4215eadb7417a2"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>IPC_RUN_PATH</b>&#160;&#160;&#160;&quot;/run/&quot;</td></tr>
<tr class="separator:a1d9abc515eaca8f30f4215eadb7417a2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa70926ca30ee98b193e64ef623f44556"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aa70926ca30ee98b193e64ef623f44556"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>IPC_HOME_RUN_PATH</b>&#160;&#160;&#160;IPC_HOME_PATH IPC_RUN_PATH</td></tr>
<tr class="separator:aa70926ca30ee98b193e64ef623f44556"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a22de351993e78407550fe96832679286"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ipc_8c.html#a22de351993e78407550fe96832679286">ipc_get_pid_file_path</a> (char *dst_path, char *pid_path)</td></tr>
<tr class="memdesc:a22de351993e78407550fe96832679286"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the pid file path for the watch constructed from the folder.  <a href="#a22de351993e78407550fe96832679286">More...</a><br /></td></tr>
<tr class="separator:a22de351993e78407550fe96832679286"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3afaf4791a2c7adbc333713aa73a11a2"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a3afaf4791a2c7adbc333713aa73a11a2"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ipc_8c.html#a3afaf4791a2c7adbc333713aa73a11a2">ipc_sig_handler</a> ()</td></tr>
<tr class="memdesc:a3afaf4791a2c7adbc333713aa73a11a2"><td class="mdescLeft">&#160;</td><td class="mdescRight">IPC signal handler for SIGTERM|SIGINT that remove the watch and optionally call a callback. <br /></td></tr>
<tr class="separator:a3afaf4791a2c7adbc333713aa73a11a2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a869a843644acd5eab7270099bc112a69"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ipc_8c.html#a869a843644acd5eab7270099bc112a69">ipc_set_watch</a> (char *dst_path, ipc_stop_callback cb, void *cb_arg)</td></tr>
<tr class="memdesc:a869a843644acd5eab7270099bc112a69"><td class="mdescLeft">&#160;</td><td class="mdescRight">Create the instance run file for further identification by other instances, and setup signal catch.  <a href="#a869a843644acd5eab7270099bc112a69">More...</a><br /></td></tr>
<tr class="separator:a869a843644acd5eab7270099bc112a69"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4f14d264fa040d8103d6e7a2f6088f44"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ipc_8c.html#a4f14d264fa040d8103d6e7a2f6088f44">ipc_remove_watch</a> (char *dst_path)</td></tr>
<tr class="memdesc:a4f14d264fa040d8103d6e7a2f6088f44"><td class="mdescLeft">&#160;</td><td class="mdescRight">Removes the watch file for the given search path.  <a href="#a4f14d264fa040d8103d6e7a2f6088f44">More...</a><br /></td></tr>
<tr class="separator:a4f14d264fa040d8103d6e7a2f6088f44"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3cbaa8bad6fdc71f32bb803d628fcf25"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ipc_8c.html#a3cbaa8bad6fdc71f32bb803d628fcf25">ipc_stop_watch</a> (char *dst_path)</td></tr>
<tr class="memdesc:a3cbaa8bad6fdc71f32bb803d628fcf25"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stop the instance designated by the given search path, using the SIGTERM signal.  <a href="#a3cbaa8bad6fdc71f32bb803d628fcf25">More...</a><br /></td></tr>
<tr class="separator:a3cbaa8bad6fdc71f32bb803d628fcf25"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:aec456f2204fb2e615ce9e4884186e5f7"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aec456f2204fb2e615ce9e4884186e5f7"></a>
static char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ipc_8c.html#aec456f2204fb2e615ce9e4884186e5f7">g_watch_dst_path</a> [<a class="el" href="io_8h.html#a3459a8a15f99dc120380d828bc7a4cd8">IO_PATH_MAX_SIZE</a>] = &quot;&quot;</td></tr>
<tr class="memdesc:aec456f2204fb2e615ce9e4884186e5f7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Destination path on which this instance operates on. <br /></td></tr>
<tr class="separator:aec456f2204fb2e615ce9e4884186e5f7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa0e3adb6fceaeeb9422d6a46fdc30562"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aa0e3adb6fceaeeb9422d6a46fdc30562"></a>
static ipc_stop_callback&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ipc_8c.html#aa0e3adb6fceaeeb9422d6a46fdc30562">g_watch_cb</a> = NULL</td></tr>
<tr class="memdesc:aa0e3adb6fceaeeb9422d6a46fdc30562"><td class="mdescLeft">&#160;</td><td class="mdescRight">Provided callback when a signal is received. <br /></td></tr>
<tr class="separator:aa0e3adb6fceaeeb9422d6a46fdc30562"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afc105ac7cbd447a0ab79b555cd65194f"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="afc105ac7cbd447a0ab79b555cd65194f"></a>
static void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ipc_8c.html#afc105ac7cbd447a0ab79b555cd65194f">g_watch_cb_arg</a> = NULL</td></tr>
<tr class="memdesc:afc105ac7cbd447a0ab79b555cd65194f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Callback data for the callback when signal is received. <br /></td></tr>
<tr class="separator:afc105ac7cbd447a0ab79b555cd65194f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Manage communication between different instance of smartfolder. </p>
<p>In order to do this, during initialisation (ipc_set_watch), it create a file in the user home directory and put the PID of the current instance in it. The name of this file is constructed by taking the provided destination path and replacing all directory separator by an underscore.</p>
<p>It also setup two signals catch (SIGINT and SIGTERM) for cleanup purpose. The callback and callback data are provided by the caller, and stored as global for usage in the signl handler. This is this handler that also remove the file in the user home directory.</p>
<p>Now, to terminate an instance, it gets the PID of the target instance by getting it in the concerned file. To get this file, it does the same string replacement in the provided destination folder to have the right name. Then, with the PID, it launch a SIGTERM signal to the instance.</p>
<p>When a signal is received, the signal handler will first remove the file and call the callback if any.</p>
<dl class="section author"><dt>Author</dt><dd>Claudio Sousa, Gonzalez David </dd></dl>

<p>Definition in file <a class="el" href="ipc_8c_source.html">ipc.c</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a22de351993e78407550fe96832679286"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int ipc_get_pid_file_path </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>dst_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>pid_path</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Return the pid file path for the watch constructed from the folder. </p>
<p>The pid filename is constructed by simply replacing the '/' character by '_' </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dst_path</td><td>The destination path to construct the filename from </td></tr>
    <tr><td class="paramname">pid_path</td><td>String to store the resulting pid filename </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ipc_8c_source.html#l00059">59</a> of file <a class="el" href="ipc_8c_source.html">ipc.c</a>.</p>

</div>
</div>
<a class="anchor" id="a4f14d264fa040d8103d6e7a2f6088f44"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ipc_remove_watch </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>dst_path</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Removes the watch file for the given search path. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dst_path</td><td>The destination path that designate the instance </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Error indicator: 0 for OK, 1 for an error </dd></dl>

<p>Definition at line <a class="el" href="ipc_8c_source.html#l00132">132</a> of file <a class="el" href="ipc_8c_source.html">ipc.c</a>.</p>

</div>
</div>
<a class="anchor" id="a869a843644acd5eab7270099bc112a69"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ipc_set_watch </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>dst_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ipc_stop_callback&#160;</td>
          <td class="paramname"><em>cb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>cb_arg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Create the instance run file for further identification by other instances, and setup signal catch. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dst_path</td><td>The destination path this instance operates on </td></tr>
    <tr><td class="paramname">cb</td><td>Callback when a stop signal is received </td></tr>
    <tr><td class="paramname">cb_arg</td><td>Callback argument </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Error indicator: 0 for OK, 1 for an error </dd></dl>

<p>Definition at line <a class="el" href="ipc_8c_source.html#l00092">92</a> of file <a class="el" href="ipc_8c_source.html">ipc.c</a>.</p>

</div>
</div>
<a class="anchor" id="a3cbaa8bad6fdc71f32bb803d628fcf25"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ipc_stop_watch </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>dst_path</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Stop the instance designated by the given search path, using the SIGTERM signal. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">dst_path</td><td>The destination path that designate the instance </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Error indicator: 0 for OK, 1 for an error </dd></dl>

<p>Definition at line <a class="el" href="ipc_8c_source.html#l00146">146</a> of file <a class="el" href="ipc_8c_source.html">ipc.c</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
